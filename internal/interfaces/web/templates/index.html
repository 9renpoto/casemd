{{ define "index" }}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>casemd Preview</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
      :root { color-scheme: light; }
      body { font-family: sans-serif; margin: 0; padding: 2rem; background: #f7f7f7; }
      main { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; }
      section { background: #fff; border-radius: 8px; padding: 2rem; box-shadow: 0 4px 16px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
      textarea { width: 100%; flex: 1; min-height: 320px; font-family: monospace; font-size: 0.95rem; padding: 1rem; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; resize: vertical; }
      input[type="text"] { width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1rem; margin-bottom: 1rem; }
      button { padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; background: #2563eb; color: #fff; cursor: pointer; }
      button:disabled { background: #93c5fd; cursor: not-allowed; }
      label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
      .actions { margin-top: 1rem; display: flex; gap: 1rem; align-items: center; }
      .notice { margin-top: 1rem; color: #64748b; font-size: 0.9rem; }
      .error { color: #b91c1c; margin-top: 1rem; }
      h1 { margin-top: 0; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; vertical-align: top; }
      th { background: #f1f5f9; font-weight: 600; }
      .table-wrapper { flex: 1; overflow: auto; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; }
      .placeholder { color: #64748b; text-align: center; padding: 2rem; }
    </style>
  </head>
  <body>
    <main>
      <section>
        <h1>casemd Markdown Preview</h1>
        <p>This lightweight UI helps debug Markdown parsing by converting content to CSV on demand.</p>
        <form id="preview-form">
          <label for="name">Source Name</label>
          <input id="name" name="name" value="{{ .DefaultState.Name }}" placeholder="sample.md">
          <label for="markdown">Markdown Content</label>
          <textarea id="markdown" name="markdown" placeholder="# Major Item&#10;## Medium Item&#10;- [ ] Step 1">{{ .DefaultState.Markdown }}</textarea>
          <div class="actions">
            <button type="submit" id="submit">Preview CSV</button>
            <span class="notice" id="status"></span>
          </div>
          <div class="error" id="error"></div>
        </form>
      </section>
      <section>
        <h2>CSV Preview</h2>
        <div class="table-wrapper">
          <table id="csv-table" aria-live="polite">
            <thead id="csv-head"></thead>
            <tbody id="csv-body">
              <tr><td class="placeholder">Waiting for preview...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
    <script>
      const defaults = {{ json .DefaultState }};
      const form = document.getElementById("preview-form");
      const status = document.getElementById("status");
      const error = document.getElementById("error");
      const submit = document.getElementById("submit");
      const head = document.getElementById("csv-head");
      const body = document.getElementById("csv-body");

      renderTable(defaults.csv || "");

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const name = document.getElementById("name").value;
        const markdown = document.getElementById("markdown").value;
        submit.disabled = true;
        status.textContent = "Converting...";
        error.textContent = "";

        try {
          const response = await fetch("/api/preview", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, markdown })
          });

          if (!response.ok) {
            const message = await response.text();
            throw new Error(message || "conversion failed");
          }

          const result = await response.json();
          renderTable(result.csv || "");
          status.textContent = "Done";
        } catch (err) {
          error.textContent = err.message;
          status.textContent = "";
          renderTable("");
        } finally {
          submit.disabled = false;
        }
      });

      function renderTable(csvText) {
        head.innerHTML = "";
        body.innerHTML = "";

        if (!csvText.trim()) {
          body.innerHTML = '<tr><td class="placeholder">No data available.</td></tr>';
          return;
        }

        const rows = parseCSV(csvText);
        if (!rows.length) {
          body.innerHTML = '<tr><td class="placeholder">No data available.</td></tr>';
          return;
        }

        const headerRow = document.createElement("tr");
        rows[0].forEach((cell) => {
          const th = document.createElement("th");
          th.textContent = cell;
          headerRow.appendChild(th);
        });
        head.appendChild(headerRow);

        const dataRows = rows.slice(1);
        if (!dataRows.length) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.className = "placeholder";
          cell.textContent = "No rows parsed.";
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        dataRows.forEach((values) => {
          const row = document.createElement("tr");
          rows[0].forEach((_, index) => {
            const cell = document.createElement("td");
            cell.textContent = values[index] || "";
            row.appendChild(cell);
          });
          body.appendChild(row);
        });
      }

      function parseCSV(text) {
        const rows = [];
        let current = [];
        let value = "";
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const char = text[i];

          if (inQuotes) {
            if (char === '"') {
              if (text[i + 1] === '"') {
                value += '"';
                i++;
              } else {
                inQuotes = false;
              }
            } else {
              value += char;
            }
            continue;
          }

          switch (char) {
            case '"':
              inQuotes = true;
              break;
            case ",":
              current.push(value);
              value = "";
              break;
            case "\r":
              break;
            case "\n":
              current.push(value);
              rows.push(current);
              current = [];
              value = "";
              break;
            default:
              value += char;
          }
        }

        if (value !== "" || current.length) {
          current.push(value);
          rows.push(current);
        }

        return rows;
      }
    </script>
  </body>
</html>
{{ end }}
